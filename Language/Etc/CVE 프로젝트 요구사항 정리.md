
## 주제
사용자가 알림 조건을 등록하면, 신규/수정된 CVE를 자동으로 조회해서 매칭하고 알림을 보내는 서비스

## MVP 간략 스펙
- **목표**: CVE API로 데이터를 **수집**하고, 로컬 DB에 **중복 없이 저장/갱신**한 뒤, 고정된 규칙으로 **필터링 결과를 반환**한다.
- **제외**: 회원가입/로그인, 관리자 기능, 알림 전송, 규칙 등록(규칙 데이터는 DB에 미리 넣은 것으로 대체)

## MVP 기준 데이터 수집 요구사항 표
| 구분       | 기능                     | 트리거/입력                                  | 처리 내용                                                                                                                                              | 완료 기준                                                              | 산출물/로그                                                             |
| -------- | ---------------------- | --------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------ | ------------------------------------------------------------------ |
| 수집 실행 요청 | 수집 실행 API 요청 접수        | - postman으로 요청 -> 수집 실행<br>- 조회 파라미터 포함 | - 호출 시 RUNNING 으로 실행 상태 필드 값 설정<br>- 입력값 확인  <br>- 백그라운드 작업 생성  <br>- 작업ID 리턴                                                                      | - 요청 정상 접수 시 작업ID 반환  <br>- 요청 오류 시 실행 상태 값 FAIL 로 변경<br>          | 수집 작업ID, 요청 파라미터 로그, 요청 실패 사유 로그                                   |
| API 호출   | CVE API 호출 수행          | - 작업 실행 시작                              | - 백그라운드 작업 -> 외부 CVE API 호출                                                                                                                        | - API 요청 결과 상태코드에 따라 실행 상태 값 변경                                    | 외부 API 요청 시각 로그, 요청 URL 및 파라미터 로그, 호출 횟수 로그                        |
| 파이프라인 제어 | 단계 성공 여부에 따른 분기        | - 수집 실행 요청 성공 여부<br>- API 응답 성공 여부      | - 실행 요청 성공 -> API 호출 진행<br>- API 응답 성공 -> 정규화 -> 저장 -> 필터링 진행                                                                                      | - 분기 규칙에 따른 상태 전이 확인<br>- 최종 실행 상태 SUCCESS 또는 FAIL 기록              | 상태 전이 로그, job 최종 상태 로그, 실패 단계 로그                                   |
| 정규화      | JSON -> 내부 스키마 변환      | - API 원본 JSON                           | - 필요한 필드 추출  <br>- 값 타입 맞추기<br>- DB에 넣을 형태로 만들기                                                                                                    | - 내부 스키마 레코드 생성<br>- 원본 건수, 정규화 성공 건수, 정규화 실패 건수 기록                | 원본 건수 로그, 정규화 성공 건수 로그, 정규화 실패 건수 로그, 실패 cveId 및 사유 로그             |
| 저장       | 신규 insert 및 수정 update  | - 정규화된 CVE 레코드                          | - DB에 같은 cveId 존재 여부 확인<br>- cveId가 존재하면 같은 cveId끼리 lastModifiedDate 비교<br>- lastModifiedDate 값 다르면 update 수행, 같으면 skip<br>- cveId 미존재 시 insert 수행 | - cveId 유니크 제약으로 중복 저장 차단<br>- lastModifiedDate 변경된 경우에만 update 수행 | insert 건수 로그, update 건수 로그, skip 건수 로그                             |
| 부분 실패 처리 | 정규화 실패 항목              | - 개별 CVE 항목                             | - 항목 단위로 정규화 예외 처리<br>- 항목 처리 실패해도 다음 항목 처리 계속<br>- 중복된 cveId 면 스킵                                                                                 | - 일부 실패 발생 시에도 전체 파이프라인 유지<br>- 실패 항목 cveId, 실패 이유 기록              | 실패 cveId 로그, 스킵 cveId 로그, 예외 메시지 로그, 실패 단계 로그                      |
| 부분 실패 처리 | DB 저장 실패 항목            | - 개별 CVE 항목                             | - DB 예외 발생 시 해당 항목 실패 처리<br>- 다음 항목 처리 계속                                                                                                          | - 일부 DB 실패 발생 시에도 나머지 저장 지속<br>- 실패 항목 cveId, 예외 정보 기록             | 실패 cveId 로그, 예외 메시지 로그, 실패 SQL 구간 로그                               |
| 수집 결과 조회 | 수집 실행 상태 조회 및 수집 결과 조회 | - 클라이언트에서 수집 실행 상태 조회 API 요청            | - 실행 상태 값 반환<br>- 전체 CVE 항목 수, DB에 반영된 CVE 항목 수, DB 반영 실패한 CVE 항목의 cveId 반환                                                                        | - 실행 상태 및 처리된 CVE 항목 수 결과 반환                                       | 실행 상태 값, 전체 CVE 항목 수, DB에 반영된 CVE 항목 수, DB 반영 실패한 CVE 항목의 cveId 반환 |
|          |                        |                                         |                                                                                                                                                    |                                                                    |                                                                    |



## MVP 기준 데이터 필터링 요구사항 표
#### 전제 조건
- MVP 기준으로 알림 규칙 테이블에 기본 규칙이 미리 등록되어 있음
- 규칙은 대상 필드, 비교 방식, 기준값 구조를 가짐
- 최소 필터링 조건으로 신규/수정, 날짜 포함

| 구분            | 기능                      | 트리거/입력                                                                             | 처리 내용                                                                                                                                                                                                    | 완료 기준                                                                                                    | 산출물/로그                                          |
| ------------- | ----------------------- | ---------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------- | ----------------------------------------------- |
| 필터링 실행 요청     | 필터링 실행 API 요청 접수        | - postman으로 요청 -> 필터링 실행<br>- 데이터 수집 작업ID 포함<br>- 규칙 ID 포함                         | - 입력값 확인<br>- 호출 시 RUNNING 으로 실행 상태 필드 값 설정<br>- 백그라운드 작업 생성<br>- 필터링 작업ID 리턴                                                                                                                            | - 요청 정상 접수 시 필터 작업ID 반환<br>- 요청 오류 시 실행 상태 값 FAIL 로 변경                                                   | 필터링 작업ID, 요청 파라미터 로그, 요청 실패 사유 로그               |
| 알림 규칙 조회      | 알림 규칙 조회                | - 작업 실행 시작<br>- 규칙 ID                                                              | - 알림 규칙 테이블에서 규칙 정보 조회<br>- 규칙 조건 목록 조회                                                                                                                                                                  | - 규칙 조회 성공 시 다음 단계 진행<br>- 규칙 미존재 시 실행 상태 값 FAIL 로 변경                                                    | 규칙 조회 로그, 규칙 오류 로그                              |
| 필터링 대상 데이터 조회 | 가장 최근에 등록/수정된 CVE 조회    | - 데이터 수집 작업ID                                                                      | - 데이터 수집 작업ID 기준으로 최근 등록/수정 여부 판별<br>- 최근에 등록/수정된 CVE 항목 조회<br>- 필터링 대상 CVE 항목 개수 기록                                                                                                                     | - 대상 조회 성공 시 다음 단계 진행<br>- 대상 0건이면 SUCCESS 처리, 결과 목록 빈 값 저장                                              | 필터링 대상 CVE 항목 개수 로그                             |
| 조회 조건 만들기     | 규칙을 DB 조회 조건으로 바꿔서 붙이기  | - 조회한 규칙 조건 목록<br>- 대상 cveId 목록                                                    | - 규칙 조건을 DB WHERE 조건으로 조립<br>- 예: severity 이상 HIGH -> severity >= HIGH 형태로 만들기<br>- 예: 설명 포함 apache -> description LIKE %apache% 형태로 만들기<br>- 최소 조건(신규/수정, 날짜)을 항상 함께 붙이기<br>- 대상 cveId 목록 제한 조건을 함께 붙이기 | - 조립된 조건으로 DB 조회가 가능해야 함<br>- 규칙 필드가 지원하지 않는 값이면 실행 상태 값 FAIL 로 변경<br>- 기준값 타입이 맞지 않으면 실행 상태 값 FAIL 로 변경 | 조건 적용 로그, 지원하지 않는 조건 로그, 기준값 오류 로그              |
| DB 결과 조회      | 조건에 맞는 CVE 목록 조회        | - 대상 cveId 목록<br>- 조립된 조회 조건                                                       | - 대상 cveId 목록 안에서 조건에 맞는 CVE 조회<br>- 정렬 기준 고정<br>- 원본 건수, 결과 건수 계산                                                                                                                                       | - 원본 건수, 결과 건수 기록<br>- 결과 CVE 목록 생성                                                                      | 원본 건수, 결과 건수, 결과 CVE 목록                         |
| 저장            | 필터링 결과 저장               | - 결과 CVE 목록<br>- 필터 작업ID                                                           | - 필터 작업ID 기준으로 결과 CVE 목록 저장<br>- 저장 단위는 cveId 목록 기준                                                                                                                                                      | - 저장 성공 시 다음 단계 진행<br>- 저장 실패 시 실행 상태 값 FAIL 로 변경                                                        | 결과 저장 로그, 결과 저장 실패 로그                           |
| 파이프라인 제어      | 단계 성공 여부에 따른 분기         | - 필터링 실행 요청 성공 여부<br>- 규칙 조회 성공 여부<br>- 대상 조회 성공 여부<br>- 조건 적용 성공 여부<br>- 저장 성공 여부 | - 실행 요청 성공 -> 규칙 조회 진행<br>- 규칙 조회 성공 -> 대상 조회 진행<br>- 대상 조회 성공 -> 조건 적용 -> DB 결과 조회 -> 저장 진행                                                                                                             | - 분기 규칙에 따른 상태 전이 확인<br>- 최종 실행 상태 SUCCESS 또는 FAIL 기록                                                    | 상태 전이 로그, 필터 작업 최종 상태 로그, 실패 단계 로그              |
| 상태/결과 확인      | 필터링 실행 상태 조회 및 필터 결과 조회 | - 클라이언트에서 필터링 실행 상태 조회 API 요청<br>- 필터 작업ID 포함                                      | - 실행 상태 값 반환<br>- 실행 상태가 SUCCESS면 결과 CVE 목록 반환<br>- 실행 상태가 FAIL이면 실패 단계와 사유 반환                                                                                                                           | - 실행 상태 및 결과 CVE 목록 반환                                                                                   | 실행 상태 값, 원본 CVE 항목 수, 결과 CVE 항목 수, 결과 CVE 목록 반환 |
|               |                         |                                                                                    |                                                                                                                                                                                                          |                                                                                                          |                                                 |
